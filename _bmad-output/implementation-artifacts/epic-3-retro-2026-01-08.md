# Epic 3 Retrospective: Game Lobby & Player Joining

**Date:** 2026-01-08

## üéØ Goals vs Reality

| Epic Goal                               | Implementation Status | Outcome                                                                   |
| :-------------------------------------- | :-------------------- | :------------------------------------------------------------------------ |
| **Players can join via game code/link** | ‚úÖ Done               | `POST /api/games/[gameId]/join` works flawlessly.                         |
| **Server-side Ticket Generation**       | ‚úÖ Done               | Ticket validity constraints (5 #s/row, sorted) handled well.              |
| **Real-time Lobby (Pusher)**            | ‚úÖ Done               | **Fixed:** Resolved race condition where players weren't jumping to Game. |
| **Host Start Game Control**             | ‚úÖ Done               | Host can start game; validation enforces min players.                     |

---

## üõë Challenges & Struggles

### 1. "The Silent Lobby" (Game Start Bug)

**Issue:** When the host started the game, players stayed in the lobby instead of redirecting.
**Impact:** Critical UX failure; players had to manually refresh to play.
**Root Cause:** `LobbyPlayerList` component managed its own Pusher subscription. When it unmounted or re-rendered, it disconnected the channel, cutting off the `game:started` event for the parent component.
**Fix:** Refactored `GameLobbyClient` to centralize the connection lifecycle. Removed subscription logic from child components.

### 2. "Returning Player" State Complexity

**Issue:** Handling players who refreshed the page (checking `localStorage`, verifying tokens) introduced complex async states in `GameLobbyClient` (cascading renders).
**Impact:** Lint errors and potential race conditions in state updates.
**Fix:** Implemented `fetchPlayerData` logic, though verify token API integration was trickier than estimated.

---

## üèÜ Successes & Wins

1.  **Robust Ticket Logic (Story 3.1):** The decision to tackle the complex ticket generation logic first (Story 3.1) and unit test it heavily paid off. We had zero issues with invalid tickets during integration.
2.  **Clean Event Architecture:** Using specific event names (`player:joined`, `game:started`) made debugging the flow much easier compared to generic state updates.

---

## üí° Lessons Learned

1.  **Centralize WebSocket Connections:** Never let child components manage the lifecycle of a shared critical connection. The parent page/container should own the socket and pass down data or callbacks.
2.  **Explicit State Recovery:** Stories involving "Joining" must explicitly detail the "Re-joining" (refresh) acceptance criteria to avoid scope creep during dev.

---

## üìù Action Items

| ID        | Action                                                                                                                                                                                  | Owner    | Priority   | Status     |
| :-------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------- | :--------- | :--------- |
| **ACT-1** | **Epic 4 Prep:** Stress test "Number Broadcast" latency. Ensure 100+ clients can receive the number simultaneously.                                                                     | Dev Team | **High**   | ‚è≥ Pending |
| **ACT-2** | **Technical Debt:** Refactor `GameLobbyClient` `useEffect` to fix the "cascading render" lint warning properly by moving data fetching out of the effect body or wrapping it correctly. | Dev Team | **Medium** | ‚è≥ Pending |
